{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-comments me-2"></i>{{ t('chat_for_job') }}: {{ job.title }}
          </h5>
          <div>
            <a href="{{ url_for('chat.initiate_call', job_id=job.id) }}" class="btn btn-sm btn-outline-success">
              <i class="fas fa-phone me-1"></i>{{ t('call') }}
            </a>
            <a href="{{ url_for('jobs.view_job', job_id=job.id) }}" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-briefcase me-1"></i>{{ t('view_job') }}
            </a>
          </div>
        </div>
        <div class="card-body">
          <div id="messages" class="mb-3" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; background-color: #f8f9fa;">
            {% for message in messages %}
            <div class="message mb-2 p-2 rounded {% if message.user_id == current_user.id %}bg-primary text-white ms-auto{% else %}bg-light{% endif %}" style="max-width: 70%; {% if message.user_id == current_user.id %}margin-left: auto;{% endif %}">
              <div class="message-content">{{ message.content }}</div>
              <small class="message-time text-muted {% if message.user_id == current_user.id %}text-white-50{% endif %}">
                {{ message.timestamp.strftime('%H:%M') }}
                {% if message.language and message.language != 'en' %}
                  <span class="badge badge-sm bg-secondary ms-1">{{ message.language.upper() }}</span>
                {% endif %}
              </small>
            </div>
            {% endfor %}
          </div>
          
          <form id="messageForm" class="d-flex gap-2">
            <input type="hidden" id="jobId" value="{{ job.id }}">
            <div class="flex-grow-1">
              <input type="text" id="messageInput" class="form-control" placeholder="{{ t('type_message') }}" required>
            </div>
            <select id="languageSelect" class="form-select" style="width: auto;">
              <option value="en" {% if current_lang == 'en' %}selected{% endif %}>EN</option>
              <option value="hi" {% if current_lang == 'hi' %}selected{% endif %}>हिं</option>
              <option value="ta" {% if current_lang == 'ta' %}selected{% endif %}>த</option>
              <option value="te" {% if current_lang == 'te' %}selected{% endif %}>తె</option>
              <option value="bn" {% if current_lang == 'bn' %}selected{% endif %}>বা</option>
            </select>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">{{ t('job_details') }}</h6>
        </div>
        <div class="card-body">
          <p><strong>{{ t('budget') }}:</strong> ₹{{ job.budget }}</p>
          <p><strong>{{ t('location') }}:</strong> {{ job.location or t('not_specified') }}</p>
          <p><strong>{{ t('status') }}:</strong> 
            <span class="badge bg-{% if job.status == 'open' %}success{% elif job.status == 'in_progress' %}warning{% else %}secondary{% endif %}">
              {{ t(job.status) }}
            </span>
          </p>
          <p><strong>{{ t('created') }}:</strong> {{ job.created_at.strftime('%d %b %Y') }}</p>
          
          <div class="mt-3">
            <h6>{{ t('description') }}</h6>
            <p class="text-muted small">{{ job.description[:200] }}{% if job.description|length > 200 %}...{% endif %}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
const socket = io();
const jobId = document.getElementById('jobId').value;
const messagesDiv = document.getElementById('messages');
const messageForm = document.getElementById('messageForm');
const messageInput = document.getElementById('messageInput');
const languageSelect = document.getElementById('languageSelect');

// Join the job room
socket.emit('join', { job_id: parseInt(jobId) });

// Handle new messages
socket.on('new_message', function(data) {
    addMessage(data);
    scrollToBottom();
});

// Send message
messageForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const content = messageInput.value.trim();
    const language = languageSelect.value;
    
    if (content) {
        socket.emit('send_message', {
            job_id: parseInt(jobId),
            content: content,
            language: language
        });
        messageInput.value = '';
    }
});

// Add message to chat
function addMessage(message) {
    const messageDiv = document.createElement('div');
    const isCurrentUser = message.user_id === {{ current_user.id }};
    
    messageDiv.className = `message mb-2 p-2 rounded ${isCurrentUser ? 'bg-primary text-white ms-auto' : 'bg-light'}`;
    messageDiv.style.maxWidth = '70%';
    if (isCurrentUser) {
        messageDiv.style.marginLeft = 'auto';
    }
    
    const time = new Date(message.timestamp).toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
    
    let languageBadge = '';
    if (message.language && message.language !== 'en') {
        languageBadge = `<span class="badge badge-sm bg-secondary ms-1">${message.language.toUpperCase()}</span>`;
    }
    
    messageDiv.innerHTML = `
        <div class="message-content">${message.content}</div>
        <small class="message-time text-muted ${isCurrentUser ? 'text-white-50' : ''}">
            ${time} ${languageBadge}
        </small>
    `;
    
    messagesDiv.appendChild(messageDiv);
}

// Scroll to bottom
function scrollToBottom() {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Initial scroll to bottom
scrollToBottom();

// Leave room when page unloads
window.addEventListener('beforeunload', function() {
    socket.emit('leave', { job_id: parseInt(jobId) });
});
</script>
{% endblock %}
